# Vector Demo Logs Configuration
# Generates syslog demo logs, transforms to OTLP format, and forwards to Flowgate Gateway

[sources.generate_syslog]
type = "demo_logs"
format = "syslog"
count = 100000
interval = 1

[transforms.remap_syslog]
inputs = ["generate_syslog"]
type = "remap"
source = '''
syslog = parse_syslog!(.message)
severity_text = if includes(["emerg", "err", "crit", "alert"], syslog.severity) {
  "ERROR"
} else if syslog.severity == "warning" {
  "WARN"
} else if syslog.severity == "debug" {
  "DEBUG"
} else if includes(["info", "notice"], syslog.severity) {
  "INFO"
} else {
  syslog.severity
}
# Create OTLP JSON format
.resourceLogs = [{
  "resource": {
    "attributes": [
      { "key": "service.name", "value": { "stringValue": syslog.appname } },
      { "key": "host.hostname", "value": { "stringValue": syslog.hostname } }
    ]
  },
  "scopeLogs": [{
    "scope": {
      "name": syslog.msgid
    },
    "logRecords": [{
      "timeUnixNano": to_unix_timestamp!(syslog.timestamp, unit: "nanoseconds"),
      "body": { "stringValue": syslog.message },
      "severityText": severity_text,
      "attributes": [
        { "key": "syslog.procid", "value": { "stringValue": to_string(syslog.procid) } },
        { "key": "syslog.facility", "value": { "stringValue": syslog.facility } },
        { "key": "syslog.version", "value": { "stringValue": to_string(syslog.version) } }
      ]
    }]
  }]
}]
del(.message)
del(.timestamp)
del(.service)
del(.source_type)
'''

[transforms.batch_otlp]
inputs = ["remap_syslog"]
type = "reduce"
group_by = ["_batch"]
merge_strategies.resourceLogs = "array"
expire_after_ms = 500
max_events = 10

[sinks.emit_syslog]
inputs = ["batch_otlp"]
type = "http"
uri = "http://gateway:4318/v1/logs"
method = "post"

[sinks.emit_syslog.encoding]
codec = "json"

[sinks.emit_syslog.request]
headers.Content-Type = "application/json"
